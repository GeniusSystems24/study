# ุฏุฑุงุณุฉ ุญุงูุฉ: ููุงุฑูุฉ ุซูุงุซ ุทุฑู ูุชูููุฐ ุนูููุฉ INSERT ูู SQL Server

## ๐ ูุตู ุงูุญุงูุฉ

ูุฏูู ุฌุฏูู `TenantTransaction` ูุนูุฏ ูุญุชูู ุนูู:

- **Primary Key ูุฑูุจ**: `(tenantId, serviceId, id)`
- **Unique Constraint**: `(tenantId, serialNo)`
- **5 Foreign Key Constraints**
- **8 Indexes** ูุชุญุณูู ุงูุฃุฏุงุก (1 Primary Key + 7 Non-Clustered)
- **Default Values** ูู `createdAt` ู `updatedAt`

**ุงูุชุญุฏู**: ููู ูููู ุฅุฏุฑุงุฌ ุจูุงูุงุช ุฌุฏูุฏุฉ ูุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูููุฏุฑุฌุฉ ุจุฃูุซุฑ ุงูุทุฑู ูุนุงููุฉ ูุฃูุงูุงูุ

## ๐ ุชูููู ุงูุฌุฏูู

ุฑุงุฌุน ููู [`TenantTransaction`](./table.sql) ููุนุฑูุฉ ุงูุชูููู ุงููุงูู ููุฌุฏูู.

> **ููุงุญุธุฉ ูููุฉ ุญูู UDTT:** [`TenantTransactionData`](./udtt.sql) ุนุจุงุฑุฉ ุนู User-Defined Table Type (UDTT) ูุญุชูู ุนูู ุฃุนูุฏุฉ ูุดุงุจูุฉ ูุฃุนูุฏุฉ ุงูุฌุฏูู [`TenantTransaction`](./table.sql). ููู ูุชุบูุฑ ูู ุงูุฐุงูุฑุฉ ูููุณ ุฌุฏููุงู ูุนููุงูุ ูุฐูู:

- โ **ูุง ูุญุชุงุฌ ุฅูู ููุฑุณุฉ**: ุงูุนูููุงุช ุณุฑูุนุฉ ุจุฏูู overhead ุงูููุงุฑุณ
- โ **ุณุฑูุน ุฌุฏุงู**: ุนูููุงุช ุงูุฐุงูุฑุฉ ุฃุณุฑุน ุจู 10-100 ูุฑุฉ ูู ุงููุฑุต
- โ **ุงุณุชููุงู ุฐุงูุฑุฉ ูุญุณู**: ูุตูู ุฎุตูุตุงู ููุจูุงูุงุช ุงููุคูุชุฉ
- โ **ูุง ูุคุซุฑ ุนูู ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุงูุนูููุงุช ูุนุฒููุฉ ูู ุงูุฐุงูุฑุฉ
- โ๏ธ **ูุง ูุณุชููุฏ ูู ุฅุญุตุงุฆูุงุช ุงูุฌุฏูู ุงูุฃุณุงุณู**: Query Optimizer ูุง ูููู ูุนูููุงุช ุนู ุงูุจูุงูุงุช
- ๐ **ูุฐุง ูุฌุนู ุชูููู ุงูุทุฑููุฉ ุงูุฃููู โญโญโญโญ (ููุชุงุฒ)**

## ๐ ุงูุทุฑู ุงูุซูุงุซ ุงูููุชุฑุญุฉ

```sql
-- ุชุนุฑูู ูุชุบูุฑ ูู ููุน UDTT (User-Defined Table Type)
-- UDTT ุชู ุชุนุฑููู ูุณุจูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
DECLARE @TenantTransaction TenantTransactionData;
```

### ุงูุทุฑููุฉ ุงูุฃููู: UDTT with Two-Step Insert

```sql
-- ุงูุฎุทูุฉ ุงูุฃููู: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู UDTT
INSERT INTO @TenantTransaction
    (tenantId, serviceId, id, serialNo, currencyId, amount, toCurrencyId, toAmount, 
     [description], [status], creatorUserId, updatorUserId, createdAt, updatedAt)
VALUES
    (@tenantId, @serviceId, @transactionId, @serialNo, @currencyId, @amount, 
     null, null, @transactionDescription, @finalStatus, @creatorUserId, 
     @creatorUserId, @finalCreatedAt, GETDATE());

-- ุงูุฎุทูุฉ ุงูุซุงููุฉ: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู ุงูุฌุฏูู ุงููุนูู
INSERT INTO [TenantTransaction]
SELECT * FROM @TenantTransaction;
```

**ุงูููุฑุฉ**: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู UDTT (User-Defined Table Type) ุฃููุงูุ ุซู ููููุง ุฅูู ุงูุฌุฏูู ุงููุนูู.

### ุงูุทุฑููุฉ ุงูุซุงููุฉ: INSERT with OUTPUT Clause

```sql
-- ุงุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูู ุงูุฌุฏูู ุงููุนูู ูุน OUTPUT
INSERT INTO [TenantTransaction]
    (tenantId, serviceId, id, serialNo, currencyId, amount, toCurrencyId, toAmount, 
     [description], [status], creatorUserId, updatorUserId, createdAt, updatedAt)

OUTPUT inserted.* INTO @TenantTransaction -- ุงุณุชุฎุฏุงู OUTPUT Clause ูุชุฎุฒูู ุงูุจูุงูุงุช ุงูููุฏุฑุฌุฉ ูู UDTT

VALUES
    (@tenantId, @serviceId, @transactionId, @serialNo, @currencyId, @amount, 
     null, null, @transactionDescription, @finalStatus, @creatorUserId, 
     @creatorUserId, @finalCreatedAt, GETDATE());
```

**ุงูููุฑุฉ**: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูููุฏุฑุฌุฉ ูู ุนูููุฉ ูุงุญุฏุฉ.

### ุงูุทุฑููุฉ ุงูุซุงูุซุฉ: INSERT then SELECT Pattern

```sql
-- ุงูุฎุทูุฉ ุงูุฃููู: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูู ุงูุฌุฏูู ุงููุนูู
INSERT INTO [TenantTransaction]
    (tenantId, serviceId, id, serialNo, currencyId, amount, toCurrencyId, toAmount, 
     [description], [status], creatorUserId, updatorUserId, createdAt, updatedAt)
VALUES
    (@tenantId, @serviceId, @transactionId, @serialNo, @currencyId, @amount, 
     null, null, @transactionDescription, @finalStatus, @creatorUserId, 
     @creatorUserId, @finalCreatedAt, GETDATE());

-- ุงูุฎุทูุฉ ุงูุซุงููุฉ: ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ุงูููุฏุฑุฌุฉ ุงูู UDTT
INSERT INTO @TenantTransaction
SELECT *
FROM [TenantTransaction]
WHERE tenantId = @tenantId AND serviceId = @serviceId AND id = @transactionId;
```

**ุงูููุฑุฉ**: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุฃููุงูุ ุซู ุงุณุชุฑุฌุงุนูุง ูู ุงูุฌุฏูู ุจุงุณุชุฎุฏุงู Primary Key.

## ๐ฏ ุฃุณุฆูุฉ ููุชูููุฑ

1. **ุงูุฃุฏุงุก**: ุฃู ุทุฑููุฉ ุชุชููุน ุฃู ุชููู ุงูุฃุณุฑุนุ ููุงุฐุงุ
2. **ุงูุฃูุงู**: ุฃู ุทุฑููุฉ ุฃูุซุฑ ุฃูุงูุงู ูู ุจูุฆุฉ ูุชุนุฏุฏุฉ ุงููุณุชุฎุฏูููุ
3. **ุงูููุงุฑุฏ**: ุฃู ุทุฑููุฉ ุชุณุชููู ููุงุฑุฏ ุฃููุ
4. **ุงููุฑููุฉ**: ุฃู ุทุฑููุฉ ุชููุฑ ูุฑููุฉ ุฃูุจุฑ ููุชุทููุฑุ
5. **ุงููุฎุงุทุฑ**: ูุง ูู ุงููุฎุงุทุฑ ุงููุญุชููุฉ ููู ุทุฑููุฉุ

## ๐ ููุงุฑูุฉ ุณุฑูุนุฉ

| ุงููุนูุงุฑ          | ุงูุทุฑููุฉ ุงูุฃููู | ุงูุทุฑููุฉ ุงูุซุงููุฉ | ุงูุทุฑููุฉ ุงูุซุงูุซุฉ |
| ---------------- | -------------- | --------------- | --------------- |
| **ุนุฏุฏ ุงูุนูููุงุช** | 2              | 1               | 2               |
| **ุงูุฃุฏุงุก**       | โญโญโญโญ           | โญโญโญโญโญ           | โญโญ              |
| **ุงูุฃูุงู**       | โญโญโญโญ           | โญโญโญโญโญ           | โญ               |
| **ุงููุฑููุฉ**      | โญโญโญโญ           | โญโญโญ             | โญโญโญโญ           |
| **ุงูุชุนููุฏ**      | ูุชูุณุท          | ููุฎูุถ           | ุนุงูู            |

## ๐ ุงูุชุญููู ุงูููุตู

ููุญุตูู ุนูู ุชุญููู ููุตู ููู ุทุฑููุฉุ ุฑุงุฌุน ุงููููุงุช ุงูุชุงููุฉ:

- ๐ **[ุชุญููู ุงูุฃุฏุงุก](./performance_analysis.md)** - ููุงุฑูุฉ ููุตูุฉ ููุฃุฏุงุก ูุงูููุงุกุฉ
- ๐ **[ุชุญููู ุงูุฃูุงู](./security_analysis.md)** - ุชุญููู ุงููุฎุงุทุฑ ุงูุฃูููุฉ ูุงูุญูุงูุฉ
- ๐ **[ุงููุฑุงุฌุน](./references.md)** - ุงููุตุงุฏุฑ ูุงููุฑุงุฌุน ุงูุนูููุฉ

## ๐ก ุงูุชูุตูุฉ ุงูุณุฑูุนุฉ

**ููุงุณุชุฎุฏุงู ุงูุนุงู**: ุงุณุชุฎุฏู **ุงูุทุฑููุฉ ุงูุซุงููุฉ** (OUTPUT Clause)

- ุฃูุถู ุฃุฏุงุก
- ุฃุนูู ูุณุชูู ุฃูุงู
- ุฃูู ุงุณุชููุงู ููููุงุฑุฏ
- ูุชูุงููุฉ ูุน ุฃูุถู ุงูููุงุฑุณุงุช

---

> **ูุฐู ุฏุฑุงุณุฉ ุญุงูุฉ ุชุนููููุฉ ูููู ุงููุฑููุงุช ุจูู ุทุฑู INSERT ุงููุฎุชููุฉ ูู SQL Server**
